<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Create Post</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    .top-bar { position: fixed; top: 0; width: 100%; height: 50px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid gainsboro; z-index: 10; }
    .profile { display: flex; align-items: center; padding: 60px 15px 10px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
    .audience { font-size: 12px; color: gray; }
    #post-text { width: 90%; margin: 10px auto; min-height: 120px; padding: 10px; font-size: 16px; border: none; border-radius: 10px; resize: none; background-size: cover; background-position: center; background-color: white; outline: none; }
    #preview-container { display: flex; flex-wrap: wrap; padding: 10px; gap: 10px; }
    .preview-wrapper { position: relative; }
    .preview-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; }
    .remove-btn { position: absolute; top: 2px; right: 4px; background: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; padding: 2px 6px; cursor: pointer; font-size: 14px; }
    .action-bar { display: flex; justify-content: space-around; padding: 10px; background: white; position: fixed; bottom: 60px; width: 100%; border-top: 1px solid #ddd; }
    .action-bar div { cursor: pointer; font-size: 14px; color: #007bff; }
    .post-button { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 40px; background: #007bff; color: white; font-weight: bold; border: none; border-radius: 10px; }
    #events { position: fixed; left: 0; bottom: 0; width: 100%; height: 0%; background-color: white; transition: 0.2s; z-index: 20; overflow-y: auto; }
    .event-option { padding: 10px; border-bottom: 1px solid gainsboro; display: flex; gap: 10px; align-items: center; cursor: pointer; }
    .event-option img { width: 30px; height: 30px; }
    .event-label { font-size: 14px; }
  </style>
</head>
<body>
  <form id="create-post-form">
    <div class="top-bar">
      <span><b>Create Post</b></span>
      <span onclick="history.back()">✖</span>
    </div>

    <div class="profile">
      <img src="image/bolu1.jpg" class="avatar">
      <div>
        <div><b>Afolabi Boluwatife</b></div>
        <div class="audience">Public ▼</div>
      </div>
    </div>

    <textarea id="post-text" placeholder="What's on your mind?"></textarea>
    <div id="preview-container"></div>
    <input type="file" id="post-image" accept="image/*" multiple style="display: none;">
    <input type="hidden" id="event-hidden">

    <div class="action-bar">
      <div onclick="document.getElementById('post-image').click()">Photo</div>
      <div onclick="openEvent()">Tag Event</div>
      <div onclick="setBackground('image/image4.jpg')">BG 1</div>
      <div onclick="setBackground('image/image5.jpg')">BG 2</div>
    </div>

    <button type="button" onclick="savePost()" class="post-button">Post</button>
  </form>

  <div id="events">
    <div style="padding: 10px; border-bottom: 1px solid gainsboro; display: flex; align-items: center;">
      <div onclick="closeEvent()" style="margin-right: 10px;">←</div>
      <div style="font-size: 16px; font-weight: bold;">What's your event?</div>
    </div>
    <div class="event-option" onclick="selectEvent('Birthday party')">
      <img src="icon/birthday event.png"><div class="event-label">Birthday party</div>
    </div>
    <div class="event-option" onclick="selectEvent('Wedding')">
      <img src="icon/wedding event.png"><div class="event-label">Weddings</div>
    </div>
    <div class="event-option" onclick="selectEvent('Graduations')">
      <img src="icon/graduation event.png"><div class="event-label">Graduations</div>
    </div>
  </div>

  <script>

  let postBackground = "";

  function savePost() {
  const text = document.getElementById("post-text").value.trim();
  const event = document.getElementById("event-hidden").value;
  const files = document.getElementById("post-image").files;

  if (!text && files.length === 0 && !postBackground) {
    alert("Write something or add image/background.");
    return;
  }

  const post = {
    userName: "Afolabi Boluwatife",
    userAvatar: "image/bolu1.jpg",
    text,
    background: postBackground,
    event,
    images: [],
    timestamp: new Date().toISOString()
  };

  let totalImageSize = 0;
  for (let file of files) {
    totalImageSize += file.size;
  }

  const maxSize = 4 * 1024 * 1024; // 4MB
  if (totalImageSize > maxSize) {
    alert("Total image size is too large (limit is 4MB). Please choose smaller or fewer images.");
    return;
  }

  if (files.length === 0) {
    saveToLocal(post);
    return;
  }

  let loaded = 0;
  Array.from(files).forEach(file => {
    if (!file.type.startsWith("image/")) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      resizeImage(e.target.result, 800, 800, compressed => {
        post.images.push(compressed);
        loaded++;
        if (loaded === files.length) saveToLocal(post);
      });
    };
    reader.readAsDataURL(file);
  });
}
  function resizeImage(base64, maxWidth, maxHeight, callback) {
    const img = new Image();
    img.onload = function () {
      let canvas = document.createElement('canvas');
      let ctx = canvas.getContext('2d');

      let width = img.width;
      let height = img.height;

      if (width > maxWidth || height > maxHeight) {
        if (width > height) {
          height = Math.round((height *= maxWidth / width));
          width = maxWidth;
        } else {
          width = Math.round((width *= maxHeight / height));
          height = maxHeight;
        }
      }

      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      callback(canvas.toDataURL('image/jpeg', 0.7)); // Compress quality (0.7)
    };
    img.src = base64;
  }

  function saveToLocal(post) {
    try {
      const posts = JSON.parse(localStorage.getItem("posts") || "[]");
      posts.unshift(post);
      localStorage.setItem("posts", JSON.stringify(posts));
      window.location.href = "homepage.html";
    } catch (e) {
      alert("Failed to save post: Too much data (try smaller images).");
    }
  }
</script>
  
</body>
</html>